#include "beetles_app.h"
#include "app_ota.h"

#define OTA_FRM_ID  (APP_OTA_ID+0X10)

typedef struct ota_btn_ui_s
{
	GUI_RECT btn_yes_rect;
	GUI_RECT btn_no_rect;
	GUI_RECT btn_cancle_rect;

} ota_btn_ui_t;


static __u8 ota_load_tid = 0;

static __krnl_event_t *ota_control_sem = NULL;

#define PEND_OTA_CTL_SEM  do{\
		__u8 err;\
		if(ota_control_sem)\
		{\
			esKRNL_SemPend(ota_control_sem, 0, &err);\
		}\
	}while(0);


#define POST_OTA_CTL_SEM do{\
		if(ota_control_sem)\
		{\
			esKRNL_SemPost(ota_control_sem);\
		}\
	}while(0);




static H_LYR ota_layer_32bpp_create(RECT rect , __s32 pipe)
{

	H_LYR layer = NULL;
	FB  fb =
	{
		{0, 0},                                   		/* size      */
		{0, 0, 0},                                      /* buffer    */
		//   {FB_TYPE_RGB, {PIXEL_MONO_8BPP, 0, (__rgb_seq_t)0}},    /* fmt       */
		{FB_TYPE_RGB, {PIXEL_COLOR_ARGB8888, 0, (__rgb_seq_t)0}},    /* fmt       */

	};

	__disp_layer_para_t lstlyr =
	{
		//    DISP_LAYER_WORK_MODE_PALETTE,                    /* mode      */
		DISP_LAYER_WORK_MODE_NORMAL,                    /* mode      */
		0,                                              /* ck_mode   */
		0,                                              /* alpha_en  */
		0,                                              /* alpha_val */
		1,                                              /* pipe      */
		0xff,                                           /* prio      */
		{0, 0, 0, 0},                           		/* screen    */
		{0, 0, 0, 0},                               	/* source    */
		DISP_LAYER_OUTPUT_CHN_DE_CH1,                   /* channel   */
		NULL                                            /* fb        */
	};

	__layerwincreate_para_t lyrcreate_info =
	{
		"wifi layer",
		NULL,
		GUI_LYRWIN_STA_SLEEP,
		GUI_LYRWIN_NORMAL
	};

	fb.size.width		= rect.width;
	fb.size.height		= rect.height;

	lstlyr.src_win.x  		= 0;
	lstlyr.src_win.y  		= 0;
	lstlyr.src_win.width 		= rect.width;
	lstlyr.src_win.height 	= rect.height;

	lstlyr.scn_win.x		= rect.x;
	lstlyr.scn_win.y		= rect.y;
	lstlyr.scn_win.width  	= rect.width;
	lstlyr.scn_win.height 	= rect.height;

	lstlyr.pipe = pipe;
	lstlyr.fb = &fb;
	lyrcreate_info.lyrpara = &lstlyr;

	layer = GUI_LyrWinCreate(&lyrcreate_info);

	if(!layer)
	{
		__wrn("app bar layer create error !\n");
	}

	return layer;
}




static ota_btn_ui_t  ota_btn_ui_800_480 =
{

	{30, 81, 67, 99},
	{124, 81, 161, 99},
	{77, 81, 114, 99},


};


__s32  ota_cmd2parent(H_WIN hwin, __s32 id, __s32 data2, __s32 reserved)
{
	H_WIN hparent;
	__gui_msg_t msg;

	hparent = GUI_WinGetParent(hwin);

	if(!hparent)
	{
		__err("hparent is null...\n");
		return EPDK_FAIL;
	}

	msg.h_deswin = hparent;
	msg.h_srcwin = hwin;
	msg.id = GUI_MSG_COMMAND;
	msg.dwAddData1 = MAKELONG(GUI_WinGetItemId(hwin), id);
	msg.dwAddData2 = data2;
	msg.dwReserved = reserved;

	GUI_SendNotifyMessage(&msg);

	return EPDK_OK;
}

static __s32 ota_frm_touch_proc(__gui_msg_t *msg)
{
	__s32 x = 0, y = 0;
	__s32 speed = 0, direct = 0;
	__s32 index;

	__s32 max_mid_w;
	__s32 bg_pos;
	__s32 bg_w;
	__s32 val;
	ota_attr_t *ota_attr;

	direct = HISWORD(msg->dwReserved);

	ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);


	x = LOSWORD(msg->dwAddData2);
	y = HISWORD(msg->dwAddData2);
	tp_ad("x:%d,y%d\n", x, y);
	speed = LOSWORD(msg->dwReserved);

	return EPDK_OK;
}

static void ota_res_init(ota_attr_t *ota_attr)
{
	if(!ota_attr->bg_bmp)
	{
		ota_attr->bg_bmp = dsk_theme_open(ID_DIALOG_MSGBOX_BMP);
		ota_attr->bg_bmp_buf = dsk_theme_hdl2buf(ota_attr->bg_bmp);
	}

	if(!ota_attr->btn_n_bmp)
	{
		ota_attr->btn_n_bmp = dsk_theme_open(ID_DIALOG_OTA_DIALOG_UNFC_BMP);
		ota_attr->btn_n_bmp_buf = dsk_theme_hdl2buf(ota_attr->btn_n_bmp);
	}

	if(!ota_attr->btn_f_bmp)
	{
		ota_attr->btn_f_bmp = dsk_theme_open(ID_DIALOG_OTA_DIALOG_FC_BMP);
		ota_attr->btn_f_bmp_buf = dsk_theme_hdl2buf(ota_attr->btn_f_bmp);
	}

}
static void ota_res_uninit(ota_attr_t *ota_attr)
{
	if(ota_attr->bg_bmp)
	{
		dsk_theme_close(ota_attr->bg_bmp);
		ota_attr->bg_bmp = NULL;
		ota_attr->bg_bmp_buf = NULL;
	}

	if(ota_attr->btn_n_bmp)
	{
		dsk_theme_close(ota_attr->btn_n_bmp);
		ota_attr->btn_n_bmp = NULL;
		ota_attr->btn_n_bmp_buf = NULL;
	}

	if(ota_attr->btn_f_bmp)
	{
		dsk_theme_close(ota_attr->btn_f_bmp);
		ota_attr->btn_f_bmp = NULL;
		ota_attr->btn_f_bmp_buf = NULL;
	}

}


__s32 ota_show_loading_tip(ota_attr_t *ota_attr)
{
	char string[256] = {0};
	GUI_RECT gui_rect;
	RECT rect;
	GUI_MEMDEV_Handle draw_mem;//..

	if(!ota_attr->tips_layer)
	{
		rect.width = GUI_BMP_GetXSize(ota_attr->bg_bmp_buf);
		rect.height = GUI_BMP_GetYSize(ota_attr->bg_bmp_buf);
		rect.x = _X(617);
		rect.y = _Y(275);
		ota_attr->tips_layer = ota_layer_32bpp_create(rect, 1);
	}

	gui_rect.x0 = _X(638);
	gui_rect.y0 = _Y(429);
	gui_rect.x1 = _X(1024);
	gui_rect.y1 = gui_rect.y0 + 40;

	dsk_langres_get_menu_text(STRING_NET_LOAD, string, sizeof(string));


	GUI_LyrWinSel(ota_attr->tips_layer);//
	GUI_UC_SetEncodeUTF8();
	GUI_SetColor(GUI_BLACK);
	GUI_SetFont(SWFFont);
	GUI_SetDrawMode(GUI_DRAWMODE_NORMAL);
	draw_mem = GUI_MEMDEV_Create(0, 0, 800, 480); //
	GUI_MEMDEV_Select(draw_mem);//

	GUI_BMP_Draw(ota_attr->bg_bmp_buf, 0, 0);

	GUI_DispStringInRect(string, &gui_rect, GUI_TA_VCENTER | GUI_TA_HCENTER);

	GUI_MEMDEV_CopyToLCD_Ex(draw_mem);//
	GUI_MEMDEV_Select(NULL);//
	GUI_MEMDEV_Delete(draw_mem);//
	draw_mem = NULL; //
	GUI_LyrWinSetSta(ota_attr->tips_layer, GUI_LYRWIN_STA_ON);
	GUI_LyrWinSetTop(ota_attr->tips_layer);
}
typedef enum
{
	m_eOnBnIdx_chkNew = 0,
	m_eOnBnIdx_exit,
	m_eOnBnIdx_total,

	m_eOnBnIdx_update = m_eOnBnIdx_chkNew
} E_ON_BN_IDX;

typedef enum
{
	m_eOnPaintIdx_exBn_chkNew = 0,
	m_eOnPaintIdx_exBn_exit,
	m_eOnPaintIdx_exIcon,
	m_eOnPaintIdx_exInfoCur,
	m_eOnPaintIdx_exInit,
	
	m_eOnPaintIdx_exInfoNew,
	m_eOnPaintIdx_exBn_update,
	m_eOnPaintIdx_updateProg,
	m_eOnPaintIdx_load_err,
	m_eOnPaintIdx_exOtaProg = 0x200
} E_ON_PAINT_IDX_EX;

static H_WIN gs_hWinFrm_ota = NULL;

//回调函数显示进度的百分比, 不要在这个函数里面停留过久. 最好把里面的值给其他线程去处理显示.
static __s32 get_progress(void *arg)
{
	static int s_progBk = -1;
	int progress = (int)arg;	//progress : 0 ~ 100

	if(s_progBk != progress)
	{
		s_progBk = progress;
		NOTIFY_MSG(GUI_MSG_PAINT, NULL, gs_hWinFrm_ota, m_eOnPaintIdx_exOtaProg, progress, 0);
	}

	return 0;
}

static __s32 ota_data_save(char *file_name,__u32 save_len,char *stream_data)
{
	ES_FILE * file;
	if(file_name == NULL || file_name[0] == 0)
	{
		return EPDK_FAIL;
	}
	if(stream_data == NULL)
	{
		return EPDK_FAIL;
	}
	file = eLIBs_fopen(file_name, "w+");
	if(file != NULL )
	{//保存数据
		__s32 file_len;
		char* stream_data_temp;
		file_len = save_len;
		stream_data_temp = stream_data;
		while(file_len > 0)
		{
			eLIBs_fwrite(stream_data_temp, (file_len>(256*1024))?(256*1024):file_len, 1, file);
			file_len -= (256*1024);
			stream_data_temp += (256*1024);
			esKRNL_TimeDly(10);
		}
		eLIBs_fclose(file); 
		return EPDK_OK;
	}
	if(file)
	{
		eLIBs_fclose(file);
	}
	return EPDK_FAIL;
}

__u8 *download_img(int *stream_len)
{
	bbc_firmware *fir = NULL;
	__u8 *img_buf = NULL;
	char fw_md5[64]= {0};
	__s32 ret;
//	int stream_len = 0;;
	//先确保bbc.mod模块加载, 如果没有加载会死机, 一般微信相框会加载
	fir = bbc_get_firmwareInfo();
	if(fir == NULL)
	{
		return NULL;
	}
	eDbug("fir->url:%s\n",fir->url);
	img_buf = cacti_download_prog(fir->url, stream_len, esKRNL_GetCallBack((__pCBK_t)get_progress));
	eDbug("-- *stream_len = %d -- \n", *stream_len);
	ota_data_save("f:\\sys\\melis100.img", *stream_len, img_buf);	
	//ret = lib_md5_encrypt(img_buf, fw_md5);
	ret = lib_file_md5_encrypt("f:\\sys\\melis100.img", fw_md5);
	if(ret == EPDK_FAIL)
		return NULL; 
	eLIBs_remove("f:\\sys\\melis100.img");
	eDbug("-- fir->md5: %s -- \n", fir->md5);
	eDbug("-- fw_md5: %s -- \n", fw_md5);
	eDbug("-- cmp = %d -- \n", eLIBs_strcmp(fw_md5, fir->md5));
	if(eLIBs_strcmp(fw_md5, fir->md5))
		return NULL;
	{
		eDbug("=============download img file OK!=================\n");
		eDbug("img ver        :%s\n", fir->ver);
		eDbug("img description:%s\n", fir->description);
		eDbug("===================================================\n");
		//通过img_buf去升级固件
		//todo
	}
	if(fir)
	{
		bbc_free_firmwareInfo(fir);
		fir = NULL;
	}
	return img_buf;
}
static __s32 progress_record = -1;
void fw_update_img(H_LYR hlyr, char *img_buf)
{
	__u8 	mid_update;
	__mp 	*mod_update;
	__s32 progress;

	RECT rectHlyr;
	fw_update_res_t prog_ui[fw_update_prog_icon_num];

	__msg("esKSRV_SysInfo: %d", esKSRV_SysInfo());
	if(!hlyr)
	{
		__wrn("fw_update: hlyr is NULL!\n");
		return;
	}

	//..GUI_LyrWinGetScnWindow(hlyr, &rectHlyr);

	memset(prog_ui, 0, sizeof(prog_ui));
	mid_update = esMODS_MInstall(BEETLES_APP_ROOT"mod\\update.mod", 0);

	if(mid_update == 0)
	{
		__err("update mod install error \n");
		goto err1;
	}

	mod_update = esMODS_MOpen(mid_update, 0);

	if(mod_update == NULL)
	{
		__err("open update mode error \n");
		esMODS_MUninstall(mid_update);
		goto err1;
	}

	//__msg("mod_update = %x,file=%s\n", mod_update, fw_path);
	esMODS_MIoctrl(mod_update, UPDATE_CMD_START, 1, (void *)img_buf);
	__msg(" ioctrl mod update UPDATE_CMD_START end\n");

	while(1)
	{
		esKRNL_TimeDly(10);
		progress = esMODS_MIoctrl(mod_update, UPDATE_CMD_CHECK_PROG, 0, 0);

		if(-1  == progress)
		{
			__err("error occur\n");
			break;
		}

		__msg("current progress is %d%%\n", progress);
		//..fw_update_prog_draw(prog_ui, 0, 100, progress);
		if(progress_record != progress)
		{
			progress_record = progress;
			//eLIBs_printf("progress_record = %d\n", progress);
			NOTIFY_MSG(GUI_MSG_PAINT, NULL, gs_hWinFrm_ota, m_eOnPaintIdx_updateProg, progress, 0);
		}
		if(100 == progress)
		{
			__msg("update complete\n");
			{
				#if !BOOT_FROM_SDMMC
				esKRNL_TimeDly(250);
				dsk_display_lcd_off(OP_SCREENOFF_AND_BKOFF);
				//eLIBs_printf("system reset...");
				esKRNL_TimeDly(50);
				esKSRV_Reset();
				#endif
			}
			esMODS_MIoctrl(mod_update, UPDATE_CMD_STOP, 0, 0);
			__msg(" ioctrl mod update UPDATE_CMD_STOP end\n");
		}
	}

	esMODS_MClose(mod_update);
	esMODS_MUninstall(mid_update);
err1:
	;
	return ;
}

static void ota_load_thread(void *p_arg)
{
	__gui_msg_t *msg = (__gui_msg_t*)p_arg;

	while(1)
	{


		esKRNL_TimeDly(2);
		//eLIBs_printf("================thread running\n");
		PEND_OTA_CTL_SEM;

		if(esKRNL_TDelReq(EXEC_prioself) == OS_TASK_DEL_REQ)
		{
			 break;
		}



		{
			int stream_len = 0;
			int content_size = 0;
			ota_attr_t *ota_attr = (ota_attr_t *)GUI_WinGetAttr(GUI_WinGetHandFromName("ota frame win"));

			//eLIBs_printf("ota_attr->state=%d\n", ota_attr->state);

			if(m_eOtaSta_load == ota_attr->state)
			{
				//加载固件:
				__msg("FW Loading ...\n[URL]%s\n", ota_attr->xml->url);
				//..fw_load_prog_paint_init(ota_attr->layer);
				
//				esKRNL_TimeDly(20);

				//GUI_LyrWinSetSta(ota_attr->layer, GUI_LYRWIN_STA_SLEEP);
				//ota_show_loading_tip(ota_attr);

				if(strlen(ota_attr->xml->url) > 3)
				{
					//					ota_attr->img = srvnet_GetOctetBuf(ota_attr->xml->url, &content_size);
				}

				ota_attr->img = download_img(&stream_len);
				
				//...fw_load_prog_paint_uninit();

				//升级固件:
				eDbug("FW updating ...\n[IMG]0x%X\n", ota_attr->img);
				ota_attr->state = m_eOtaSta_update_begain;
				NOTIFY_MSG(GUI_MSG_PAINT, NULL, gs_hWinFrm_ota, m_eOnPaintIdx_updateProg, 0, 0);
				//GUI_LyrWinSetSta(ota_attr->layer, GUI_LYRWIN_STA_SLEEP);
				#if 1 //..
				if(ota_attr->img)
				{
					eDbug("-- load img --\n");
				
					ota_attr->state = m_eOtaSta_update;
					fw_update_img(ota_attr->layer, ota_attr->img);
					cacti_free_download_prog(ota_attr->img, stream_len);
				}
				else
				{
					eDbug("-- img is null --\n");
					ota_attr->state = 0;
					//app_tips_show(NULL, STRING_OTA_FW_LOAD_ERR);
					//OnPaint(msg, m_eOnPaintIdx_exBn_update, 1);
					//OnPaint(msg, m_eOnPaintIdx_exInfoCur, 0);
					//OnPaint(msg, m_eOnPaintIdx_exInfoNew, 0);					
					NOTIFY_MSG(GUI_MSG_PAINT, NULL, gs_hWinFrm_ota, m_eOnPaintIdx_load_err, 0, 0);
				}
				#endif
				__msg("FW update completed!\n");
			}

		}

		//__wrn("oldfocus:%d, focus:%d\n", sel_menu_attr->old_focus_id, sel_menu_attr->focus_id);



	}
	
	esKRNL_TDel(EXEC_prioself);

	//esKRNL_TimeDly(2);



}
__s32 app_bmp_get_width_height(void* bmp_buf,__s32* p_width,__s32* p_height)
{
	HBMP hbmp = NULL;
	hbmp = bmp_open(bmp_buf);
	if(hbmp)
	{
		*p_width = bmp_get_width(hbmp);
		*p_height = bmp_get_height(hbmp);
		bmp_close(hbmp);
		return EPDK_OK;
	}
	else
	{
		return EPDK_FAIL;
	}
}

static __s32 app_ota_tip_show(H_LYR *lyr,__s32 text_id)
{
	RECT rect;
	HTHEME bmp;
	HTHEME bmp_info;
	HTHEME bmp_f;
	char buf[64] = {0};
	char sure[10] = {0};
	char buf_dolg[20] = {0};
	GUI_RECT	gui_rect;
	__s32			screen_width;
	__s32			screen_height;
	dsk_display_get_size(&screen_width, &screen_height);
	bmp = theme_open(ID_DIALOG_MSGBOX_BMP);
	bmp_info = theme_open(ID_DIALOG_ICON_INFORMATION_BMP);
	bmp_f = theme_open(ID_DIALOG_MSGBOX_BTN_F_BMP);
	app_bmp_get_width_height(theme_hdl2buf(bmp),&rect.width,&rect.height);
	rect.x = (screen_width - rect.width) / 2;
	rect.y = (screen_height - rect.height) / 2;
	*lyr = ota_layer_32bpp_create(rect,1);
	GUI_LyrWinSetSta(*lyr, GUI_LYRWIN_STA_ON);
	dsk_langres_get_menu_text(text_id,buf, sizeof(buf));
	dsk_langres_get_menu_text(STRING_DIALOG_OK,sure,sizeof(sure));
	dsk_langres_get_menu_text(STRING_DIALOG_DIALOG,buf_dolg,sizeof(buf_dolg));
	GUI_LyrWinSel(*lyr);
	GUI_SetBkColor(0x00);
	GUI_UC_SetEncodeUTF8();
	GUI_SetColor(GUI_BLACK);
	GUI_BMP_Draw(theme_hdl2buf(bmp), 0 ,0);
	GUI_BMP_Draw(theme_hdl2buf(bmp_info), 10 ,30);
	GUI_BMP_Draw(theme_hdl2buf(bmp_f), 85 ,110);
	gui_rect.x0 = 10;
	gui_rect.y0 = 5;
	gui_rect.x1 = gui_rect.x0 + 120;
	gui_rect.y1 = gui_rect.y0 + 30;
	GUI_DispStringInRect(buf_dolg, &gui_rect, GUI_TA_LEFT | GUI_TA_VCENTER);
	gui_rect.x0 = 5;
	gui_rect.y0 = 60;
	gui_rect.x1 = gui_rect.x0 + (rect.width-10);
	gui_rect.y1 = gui_rect.y0 + 30;
	eDbug("-- x0=%d, x1=%d --\n", gui_rect.x0, gui_rect.x1);
	GUI_DispStringInRect(buf, &gui_rect, GUI_TA_HCENTER | GUI_TA_VCENTER);
	gui_rect.x0 = 105;
	gui_rect.y0 = 125;
	gui_rect.x1 = gui_rect.x0 + 60;
	gui_rect.y1 = gui_rect.y0 + 30;
	GUI_DispStringInRect(sure, &gui_rect, GUI_TA_CENTER | GUI_TA_VCENTER);
	if(bmp_info)
	{
		theme_close(bmp_info);
		bmp_info = NULL;
	}
	if(bmp)
	{
		theme_close(bmp);
		bmp = NULL;
	}
	if(bmp_f)
	{
		theme_close(bmp_f);
		bmp_f = NULL;
	}
	GUI_LyrWinSetTop(*lyr);	
	return EPDK_OK;
}
static __s32 app_ota_tip_clean(H_LYR lyr)
{
	if(lyr)
	{
		GUI_LyrWinSel(lyr);
		GUI_ClearRect(0, 0, 200, 200);
		GUI_LyrWinDelete(lyr);
		lyr = NULL;
	}
	return EPDK_OK;
}


#if 1
static __s32 ota_touch_proc(__gui_msg_t *msg, ota_attr_t *ota_attr)
{
	__s32 x = 0, y = 0;
	__s32 speed = 0;
	__s32 index;
	x = LOSWORD(msg->dwAddData2);
	y = HISWORD(msg->dwAddData2);
	speed = LOSWORD(msg->dwReserved);
	switch(msg->dwAddData1)
	{
		case GUI_MSG_TOUCH_OVERDOWN:
		case GUI_MSG_TOUCH_DOWN:
		{
			if(GUI_WinGetCaptureWin() != msg->h_deswin)				// 设置capture
			{
				GUI_WinSetCaptureWin(msg->h_deswin);
			}

			if(((x >= ota_attr->rectBn[0].x0) && (x <= ota_attr->rectBn[0].x1)) &&
				((y >= ota_attr->rectBn[0].y0) && (y <= ota_attr->rectBn[0].y1)))	//退出键
			{
				if(ota_attr->state <= m_eOtaSta_load)
			{
					OnPaint(msg, m_eOnPaintIdx_exBn_exit, 1);
					ota_attr->touchBn = 1;
				}
			}
			else if(((x >= ota_attr->rectBn[1].x0) && (x <= ota_attr->rectBn[1].x1)) &&
					((y >= ota_attr->rectBn[1].y0) && (y <= ota_attr->rectBn[1].y1)))
				{
				if(!ota_attr->xml)
					{
					OnPaint(msg, m_eOnPaintIdx_exBn_chkNew, 1);
					ota_attr->touchBn = 2;

					}
				else if(ota_attr->state <= m_eOtaSta_load)
					{
					OnPaint(msg, m_eOnPaintIdx_exBn_update, 1);
					ota_attr->touchBn = 3;
				}
			}
			__msg("ota_attr->touchBn=%d\n", ota_attr->touchBn);
			break;
					}
		case GUI_MSG_TOUCH_OVERMOVE:
		case GUI_MSG_TOUCH_MOVE:
					{
			if(((x >= ota_attr->rectBn[0].x0) && (x <= ota_attr->rectBn[0].x1)) &&
				((y >= ota_attr->rectBn[0].y0) && (y <= ota_attr->rectBn[0].y1))) //退出键
			{
				if(ota_attr->touchBn)
				{
					OnPaint(msg, m_eOnPaintIdx_exBn_exit, 0);
					}
				}
			else if(((x >= ota_attr->rectBn[1].x0) && (x <= ota_attr->rectBn[1].x1)) &&
					((y >= ota_attr->rectBn[1].y0) && (y <= ota_attr->rectBn[1].y1)))
			{
				if(ota_attr->touchBn)
				{
					if(!ota_attr->xml)
					{
						OnPaint(msg, m_eOnPaintIdx_exBn_chkNew, 0);
					}
					else if(ota_attr->state <= m_eOtaSta_load)
					{
						OnPaint(msg, m_eOnPaintIdx_exBn_update, 0);
					}
				}
			}
				else
				{
				ota_attr->touchBn = 0;
			}

			break;
		}
		case GUI_MSG_TOUCH_OVERUP:
		case GUI_MSG_TOUCH_UP:
		{
			if(GUI_WinGetCaptureWin() == msg->h_deswin)
			{
				GUI_WinReleaseCapture();
			}

			eDbug("ota_attr->touchBn=%d\n", ota_attr->touchBn);
			switch(ota_attr->touchBn)
			{
				case 1:
					ota_cmd2parent(msg->h_deswin, SWITCH_TO_MMENU, 0, 0);
					break;
				//if(x>(ota_btn_ui_800_480.btn_yes_rect.x0-10+304)&&x<(ota_btn_ui_800_480.btn_yes_rect.x1+10+304)&&
				case 2:
				{
					{
						OnPaint(msg, m_eOnPaintIdx_exBn_chkNew, 0);
						ota_attr->xml = bbc_get_firmwareInfo();
						__msg("ota_attr->xml=0x%X\n", ota_attr->xml);
					//		y>(ota_btn_ui_800_480.btn_yes_rect.y0-10+189)&&y<(ota_btn_ui_800_480.btn_yes_rect.y1+10+189))//..是
						if(ota_attr->xml == NULL)
						{
								__wrn("You need check upgrade.ini or wifi status\n");
								gscene_hbar_set_state(HBAR_ST_HIDE);
								app_tips_show(NULL, STRING_OTA_XML_STA_OTHER_CUE);
								gscene_hbar_set_state(HBAR_ST_SHOW);
								OnPaint(msg, m_eOnPaintIdx_exBn_chkNew, 1);
						}
						else
						{
							OnPaint(msg, m_eOnPaintIdx_exInfoNew, 0);
							OnPaint(msg, m_eOnPaintIdx_exBn_update, 1);
							if(!ota_load_tid)
							{
								ota_load_tid = esKRNL_TCreate(ota_load_thread, msg, 0x10000,
														  KRNL_priolevel4);//..0x800
							}
						}
					}
					break;
			}

				case 3:
			{
				#if 1
					power_level_e	 	level;
					ota_attr_t *ota_attr;
					H_LYR lyr;	

					ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);

					if(!ota_attr)
					{ break; }

					if(!ota_attr->layer)
					{ break; }

					eDbug("Here\n");
					dsk_power_get_voltage_level(&level);
					eDbug("-- level = %d -- \n", level);
					if(level < DSK_POWER_LEVEL_3)
					{
						app_ota_tip_show(&lyr,STRING_OTA_LOW_POWER_TIP);
						esKRNL_TimeDly(250);
						app_ota_tip_clean(lyr);	

						break;
					}
					else
				#endif		
					{
						__gui_msg_t mymsg;
						OnPaint(msg, m_eOnPaintIdx_exBn_update, 0);
						fw_load_prog_paint_init(ota_attr->layer);
						__here__ ;
						mymsg.h_deswin = msg->h_deswin;
						mymsg.id = m_eOtaMsg_loadFw;
						GUI_SendMessage(&mymsg);
						g_disable_close_scn();
					}
					break;
			}

				default:
					break;
			}

			ota_attr->touchBn = 0;
			break;
		}

		default:
		{
			break;
		}
	}

	__msg("ota_attr->touchBn=%d\n", ota_attr->touchBn);
	return EPDK_OK;
}
#endif


static __s32 OnPaint(__gui_msg_t *msg, E_ON_PAINT_IDX_EX paintIdx, int exParam)
{
	RECT rect;
	GUI_MEMDEV_Handle draw_mem;
	ota_attr_t *ota_attr;

	ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);

	if(!ota_attr)
	{ return EPDK_FAIL; }

	if(!ota_attr->layer)
	{ return EPDK_FAIL; }

	if((paintIdx == m_eOnPaintIdx_exBn_chkNew) && (ota_attr->xml))
	{
		paintIdx = m_eOnPaintIdx_exBn_update;
	}

	GUI_LyrWinGetScnWindow(ota_attr->layer, &rect);
	GUI_LyrWinSel(ota_attr->layer);
	GUI_SetFont(SWFFont);
	GUI_UC_SetEncodeUTF8();
	GUI_SetColor(GUI_BLACK);
	GUI_SetDrawMode(GUI_DRAWMODE_NORMAL);
	
	draw_mem = GUI_MEMDEV_Create(rect.x, rect.y, rect.width, rect.height);
	GUI_MEMDEV_Select(draw_mem);

	Funprintf("--ota inx = %d--\n",paintIdx);
	switch(paintIdx)
	{
		case m_eOnPaintIdx_exIcon:
		{
			HTHEME	hthemeIcon = dsk_theme_open(ID_INIT_OTA_ICON_BMP);
			void		*pBuf_hthemeIcon = dsk_theme_hdl2buf(hthemeIcon);			
			GUI_BMP_Draw(pBuf_hthemeIcon, _X(106), _Y(116));			
			dsk_theme_close(hthemeIcon);
			break;
		}
		
		case m_eOnPaintIdx_exBn_chkNew:
		{
			HTHEME	hthemeIcon;
			void		*pBuf_hthemeIcon;
			if(exParam)	//焦c
			{
				hthemeIcon = dsk_theme_open(ID_DIALOG_OTA_DIALOG_FC_BMP);
				GUI_SetColor(GUI_WHITE);
			}
			else
			{
				hthemeIcon = dsk_theme_open(ID_DIALOG_OTA_DIALOG_UNFC_BMP);
			}

			pBuf_hthemeIcon = dsk_theme_hdl2buf(hthemeIcon);			
			GUI_BMP_Draw(pBuf_hthemeIcon, _X(100), _Y(460));			

			{
				GUI_RECT guiRectTmp = {_X(100), _Y(460), 0, 0};
				char textTmp[128];
				dsk_langres_get_menu_text(STRING_OTA_FW_CHECK_NEW, textTmp, sizeof(textTmp));
				guiRectTmp.x1 = guiRectTmp.x0 +GUI_BMP_GetXSize(pBuf_hthemeIcon) - 1;
				guiRectTmp.y1 = guiRectTmp.y0 +GUI_BMP_GetYSize(pBuf_hthemeIcon) - 1;
				GUI_DispStringInRectWrap(textTmp, &guiRectTmp, GUI_TA_HCENTER | GUI_TA_VCENTER, GUI_WRAPMODE_CHAR);
				ota_attr->rectBn[1] = guiRectTmp;
			}
			
			dsk_theme_close(hthemeIcon);
			break;
		}
		
		case m_eOnPaintIdx_exBn_update:
		{
			HTHEME	hthemeIcon;
			void		*pBuf_hthemeIcon;
			if(exParam)	
			{
				GUI_SetColor(GUI_WHITE);
				hthemeIcon = dsk_theme_open(ID_DIALOG_OTA_DIALOG_FC_BMP);
			}
			else
			{
				hthemeIcon = dsk_theme_open(ID_DIALOG_OTA_DIALOG_UNFC_BMP);
			}
			pBuf_hthemeIcon = dsk_theme_hdl2buf(hthemeIcon);		
			GUI_BMP_Draw(pBuf_hthemeIcon, _X(100), _Y(460));	
			Funprintf("--ota w=%d h=%d--\n",GUI_BMP_GetXSize(pBuf_hthemeIcon),GUI_BMP_GetYSize(pBuf_hthemeIcon));
			{
				GUI_RECT guiRectTmp = {_X(100), _Y(460), 0, 0};
				char textTmp[128];
				dsk_langres_get_menu_text(STRING_OTA_FW_UPDATE_NEW, textTmp, sizeof(textTmp));
				guiRectTmp.x1 = guiRectTmp.x0 +GUI_BMP_GetXSize(pBuf_hthemeIcon) - 1;
				guiRectTmp.y1 = guiRectTmp.y0 +GUI_BMP_GetYSize(pBuf_hthemeIcon) - 1;
				GUI_DispStringInRectWrap(textTmp, &guiRectTmp, GUI_TA_HCENTER | GUI_TA_VCENTER, GUI_WRAPMODE_CHAR);
				ota_attr->rectBn[1] = guiRectTmp;
			}	
			dsk_theme_close(hthemeIcon);
			break;
		}
		
		case m_eOnPaintIdx_exBn_exit:
		{
			HTHEME	hthemeIcon;
			void		*pBuf_hthemeIcon;
			if(exParam)	//焦c
			{
				GUI_SetColor(GUI_WHITE);
				hthemeIcon = dsk_theme_open(ID_DIALOG_OTA_DIALOG_FC_BMP);
			}
			else
			{
				hthemeIcon = dsk_theme_open(ID_DIALOG_OTA_DIALOG_UNFC_BMP);
			}

			pBuf_hthemeIcon = dsk_theme_hdl2buf(hthemeIcon);			
			GUI_BMP_Draw(pBuf_hthemeIcon, _X(100), _Y(460)+GUI_BMP_GetYSize(pBuf_hthemeIcon)+32);			

			{
				GUI_RECT guiRectTmp = {_X(100), _Y(460), 0, 0};
				char textTmp[128];
				dsk_langres_get_menu_text(STRING_OTA_EXIT, textTmp, sizeof(textTmp));
				guiRectTmp.y0 += GUI_BMP_GetYSize(pBuf_hthemeIcon) +32;
				guiRectTmp.x1 = guiRectTmp.x0 +GUI_BMP_GetXSize(pBuf_hthemeIcon) - 1;
				guiRectTmp.y1 = guiRectTmp.y0 +GUI_BMP_GetYSize(pBuf_hthemeIcon) - 1;
				GUI_DispStringInRectWrap(textTmp, &guiRectTmp, GUI_TA_HCENTER | GUI_TA_VCENTER, GUI_WRAPMODE_CHAR);
				ota_attr->rectBn[0] = guiRectTmp;
			}
			
			dsk_theme_close(hthemeIcon);
			break;
		}
		
		case m_eOnPaintIdx_exInfoCur:
		{
			char		string[5][256] = "", textTmp[128], text[256 * 5];
			__u32 	len, i = 0;

			{
				GUI_RECT guiRectTmp = {_X(449), _Y(112), _W(772), _H(604)};
				guiRectTmp.x1 += guiRectTmp.x0 - 1;
				guiRectTmp.y1 += guiRectTmp.y0 - 1;
				GUI_SetBkColor(0);
				GUI_ClearRectEx(&guiRectTmp);
			}			
			{
				dsk_langres_get_menu_text(STRING_OTA_FW_CUR_VER, textTmp, sizeof(textTmp));
				len = eLIBs_charset_convert(EPDK_CHARSET_ENM_UTF8, EPDK_CHARSET_ENM_GBK,
											(__u8 *)textTmp, sizeof(textTmp) - 1, (__u8 *)string[i], sizeof(string[i]) - 1);
				memset(textTmp, 0, sizeof(textTmp));
				srvnet_GetCurSoftwera_Version(textTmp);
				sprintf(string[i], "%s\n  %s", string[i], textTmp);
				__msg("srvnet_GetCurSoftwera_Version: %s, %d\n", string[i], len);

				i++;
				dsk_langres_get_menu_text(STRING_OTA_FW_DEV, textTmp, sizeof(textTmp));
				len = eLIBs_charset_convert(EPDK_CHARSET_ENM_UTF8, EPDK_CHARSET_ENM_GBK,
											(__u8 *)textTmp, sizeof(textTmp) - 1, (__u8 *)string[i], sizeof(string[i]) - 1);
				memset(textTmp, 0, sizeof(textTmp));
				srvnet_GetCurSoftwera_Device(textTmp);
				sprintf(string[i], "%s\n  %s", string[i], textTmp);
				i++;
				dsk_langres_get_menu_text(STRING_OTA_FW_BRAND, textTmp, sizeof(textTmp));
				len = eLIBs_charset_convert(EPDK_CHARSET_ENM_UTF8, EPDK_CHARSET_ENM_GBK,
											(__u8 *)textTmp, sizeof(textTmp) - 1, (__u8 *)string[i], sizeof(string[i]) - 1);
				memset(textTmp, 0, sizeof(textTmp));
				srvnet_GetCurSoftwera_Brand(textTmp);
				sprintf(string[i], "%s\n  %s", string[i], textTmp);
				__msg("srvnet_GetCurSoftwera_Brand: %s, %d\n", string[i], len);

				i++;
				dsk_langres_get_menu_text(STRING_OTA_FW_NOTE, textTmp, sizeof(textTmp));
				len = eLIBs_charset_convert(EPDK_CHARSET_ENM_UTF8, EPDK_CHARSET_ENM_GBK,
											(__u8 *)textTmp, sizeof(textTmp) - 1, (__u8 *)string[i], sizeof(string[i]) - 1);
				memset(textTmp, 0, sizeof(textTmp));
				srvnet_GetCurSoftwera_Note(textTmp);
				sprintf(string[i], "%s\n  %s", string[i], textTmp);
				__msg("srvnet_GetCurSoftwera_Note: %s, %d\n", string[i], len);
			}

			GUI_UC_SetEncodeGBK();
#if 1				
			{
				GUI_RECT guiRectTmp = {_X(50), _Y(116 + 175 + 46), _W(288), _H(222)};
				guiRectTmp.x1 += guiRectTmp.x0 - 1;
				guiRectTmp.y1 += guiRectTmp.y0 - 1;
				memset(text, 0, sizeof(text));
				sprintf(text, "%s\n%s", string[0], string[1]);
				__msg("GetCurSoftwera1:\n%s\n", text);
			}
#endif			
			{
				GUI_RECT guiRectTmp = {_X(449), _Y(112), _W(772), _H(384)};
				guiRectTmp.x1 += guiRectTmp.x0 - 1;
				guiRectTmp.y1 += guiRectTmp.y0 - 1;
				sprintf(text, "%s\n%s\n%s\n%s", text, string[2], string[3], string[4]);
				GUI_DispStringInRectWrap(text, &guiRectTmp, GUI_TA_LEFT | GUI_TA_TOP, GUI_WRAPMODE_CHAR);
			}
			break;
		}
		
		case m_eOnPaintIdx_exInfoNew:
		{
			char		string[5][256] = "", textTmp[128], text[256 * 5];
			__u32 	len, i = 0;
			{
				dsk_langres_get_menu_text(STRING_OTA_FW_NEW_VER, textTmp, sizeof(textTmp));
				sprintf(string[i], "%s\n  %s", textTmp, ota_attr->xml->ver);
				i++;
				dsk_langres_get_menu_text(STRING_OTA_FW_NOTE, textTmp, sizeof(textTmp));
				sprintf(string[i], "%s\n  %s", textTmp, ota_attr->xml->description);
				__msg("srvnet_GetCurSoftwera_Note: %s, %d\n", string[i], len);
			}
			
			{
				GUI_RECT guiRectTmp = {_X(449), _Y(112+384+36), _W(772), _H(160+24)};
				guiRectTmp.x1 += guiRectTmp.x0 - 1;
				guiRectTmp.y1 += guiRectTmp.y0 - 1;
				memset(text, 0, sizeof(text));
				sprintf(text, "%s\n%s", string[0], string[1]);
				GUI_DispStringInRectWrap(text, &guiRectTmp, GUI_TA_LEFT | GUI_TA_TOP, GUI_WRAPMODE_CHAR);
				__msg("GetCurSoftwera2:\n%s\n", text);
			}
			break;
		}
		
		default:
			break;
	}	

	GUI_MEMDEV_CopyToLCD_Ex(draw_mem);
	GUI_MEMDEV_Select(NULL);
	GUI_MEMDEV_Delete(draw_mem);
	draw_mem = NULL;

	GUI_LyrWinSetSta(ota_attr->layer, GUI_LYRWIN_STA_ON);
	GUI_LyrWinSetTop(ota_attr->layer);

	return EPDK_OK;
}

firmware_xml xmlTmp =
{
	"success",
};

extern void *BBC_init(void);

static __s32 Ota_Frmwin_Proc(__gui_msg_t *msg)
{
	switch(msg->id)
	{
		case GUI_MSG_CREATE:
		{
			ota_attr_t *ota_attr;
			__u32 i;
			char file_name[256] = "f:\\ePDKv100_00.00.09.img";
			ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);
			g_disable_close_scn();
			gs_hWinFrm_ota = msg->h_deswin;

			ota_res_init(ota_attr);

			for(i = 0; i < m_eOnPaintIdx_exInit; i++)
			{
				OnPaint(msg, i, 0);
			}

			if(0 == ota_control_sem)
			{
				ota_control_sem = esKRNL_SemCreate(0);
			}
			
			#if 1
			{
				int content_size = 0;
				void *image = NULL;

				//.. esDEV_Plugin("\\drv\\usb_host0.drv", 0, NULL, 0);
				__log("host0\n");
				//.. esKRNL_TimeDly(500);

				//..link_wifi();

				//				ota_attr->xml = srvnet_GetFirmwareInfo();
			#if 1
				if(!BBC_mod_det())
				{
					__wrn("BBC.mod not install.\n");
					return EPDK_FAIL;
				}
			#else
				image = BBC_init();
				__msg("BBC_init: ret=0x%X\n", image);
			#endif
				ota_attr->xml = bbc_get_firmwareInfo();
				__msg("ota_attr->xml=0x%X\n", ota_attr->xml);

				if(ota_attr->xml == NULL)
				{
					__wrn("You need check upgrade.ini or wifi status\n");
					gscene_hbar_set_state(HBAR_ST_HIDE);
					app_tips_show(NULL, STRING_OTA_XML_STA_OTHER_CUE);
					gscene_hbar_set_state(HBAR_ST_SHOW);
					OnPaint(msg, m_eOnPaintIdx_exBn_chkNew, 1);
				}
				else
				{
					#if 1
					OnPaint(msg, m_eOnPaintIdx_exInfoNew, 0);
					OnPaint(msg, m_eOnPaintIdx_exBn_update, 1);
					if(!ota_load_tid)
					{
						ota_load_tid = esKRNL_TCreate(ota_load_thread, msg, 0x10000,KRNL_priolevel4);//..0x800
					}
					#endif
				}
			}
			#endif
			//..fw_update(ota_attr,file_name);
		}

		return EPDK_OK;

		case GUI_MSG_PAINT:
		{
			if(msg->dwAddData1 == m_eOnPaintIdx_exOtaProg)
			{
				ota_attr_t *ota_attr;
				ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);
				//eLIBs_printf("prog:%d\n",msg->dwAddData2);
				fw_load_prog_paint(ota_attr->layer, msg->dwAddData2,0);
			}
			else if(m_eOnPaintIdx_updateProg == msg->dwAddData1)
			{
				ota_attr_t *ota_attr;
				ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);
				//eLIBs_printf("prog:%d\n",msg->dwAddData2);
				if(ota_attr->state == m_eOtaSta_update_begain)
				{
					//eLIBs_printf("m_eOtaSta_update_begain\n");
					fw_update_prog_clear_s_progIdx();
					fw_load_prog_paint(ota_attr->layer, 0,1);
				}
				else if(ota_attr->state == m_eOtaSta_update)
				{
					//eLIBs_printf("m_eOtaSta_update\n");
					fw_load_prog_paint(ota_attr->layer, msg->dwAddData2,1);
				}
				else
				{}
			}
			else if(m_eOnPaintIdx_load_err == msg->dwAddData1)
			{
				
				gscene_hbar_set_state(HBAR_ST_HIDE);
					app_tips_show(NULL, STRING_OTA_FW_LOAD_ERR);
				gscene_hbar_set_state(HBAR_ST_SHOW);
					OnPaint(msg, m_eOnPaintIdx_exBn_update, 1);
					OnPaint(msg, m_eOnPaintIdx_exInfoCur, 0);
					OnPaint(msg, m_eOnPaintIdx_exInfoNew, 0);
			}
			return EPDK_OK;
		}


		case GUI_MSG_CLOSE:
		{
			__wrn("==================== who kill me?\n");
			GUI_FrmWinDelete(msg->h_deswin);
		}

		return EPDK_OK;

		case GUI_MSG_DESTROY:
		{
			ota_attr_t *ota_attr;
			ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);
			POST_OTA_CTL_SEM;
			if(ota_load_tid)
			{
				while(1)
				{
					if(esKRNL_TDelReq(ota_load_tid) == OS_TASK_NOT_EXIST)
					{
						break;
					}
					esKRNL_TimeDly(3);
				}
				ota_load_tid = NULL;
				//eLIBs_printf("...paint_octet_stream_tid[0] free\n");
			}

			tp_ad("GUI_MSG_DESTROY111.\n");

			if(ota_control_sem)
			{
				__u8    err;

				esKRNL_SemDel(ota_control_sem, OS_DEL_ALWAYS, &err);
				ota_control_sem = NULL;
				tp_ad("\n g_control_sem has been deleted.\n");
			}
			fw_load_prog_paint_uninit();//..
			ota_res_uninit(ota_attr);

			if(ota_attr->tips_layer)
			{
				GUI_LyrWinDelete(ota_attr->tips_layer);
				ota_attr->tips_layer = NULL;
			}

			if(ota_attr->xml)
			{
				bbc_free_firmwareInfo(ota_attr->xml);
				ota_attr->xml = NULL;
			}

			if(ota_attr)
			{
				esMEMS_Bfree(ota_attr, sizeof(ota_attr_t));
				ota_attr = NULL;
			}
			gs_hWinFrm_ota = NULL;
			g_enable_close_scn();
		}

		return EPDK_OK;

		case GUI_MSG_KEY:
		{
			ota_attr_t *ota_attr;
			ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);

			//__msg("dwAddData1:0x%x,dwAddData2:0x%x\n", msg->dwAddData1, msg->dwAddData2);

			if((msg->dwAddData2 == KEY_UP_ACTION))
			{ return EPDK_OK;}

			if(ota_attr->state >= m_eOtaSta_load)
			{ return EPDK_OK;}

			__here__;

			switch(msg->dwAddData1)
			{
				case GUI_MSG_KEY_LEFT:
				{
					OnPaint(msg, ota_attr->bnIdx, 0);
					if(++ota_attr->bnIdx >= m_eOnBnIdx_total)	{ ota_attr->bnIdx = 0; }
					OnPaint(msg, ota_attr->bnIdx, 1);

					break;

				}
				
				case GUI_MSG_KEY_RIGHT:
				case GUI_MSG_KEY_LONGRIGHT:
				{
					OnPaint(msg, ota_attr->bnIdx, 0);
					if(--ota_attr->bnIdx < 0)	{ ota_attr->bnIdx = m_eOnBnIdx_total - 1; }
					OnPaint(msg, ota_attr->bnIdx, 1);

					break;
				}


				case GUI_MSG_KEY_ENTER:
				{
					switch(ota_attr->bnIdx)
					{
						case m_eOnBnIdx_chkNew:
						{
							if(ota_attr->xml)
							{
								__u8	powerLevel = 0x80;
								__s32 voltage;
								voltage = dsk_power_get_battery_level(&powerLevel);
								//eLIBs_printf("voltage=%d, powerLevel=0x%X\n", voltage, powerLevel);
								//..if(voltage > 3600)
								{
									__gui_msg_t mymsg;
									OnPaint(msg, m_eOnPaintIdx_exBn_update, 0);
									fw_load_prog_paint_init(ota_attr->layer);
									//加载、升级固件
									__here__ ;
									mymsg.h_deswin = msg->h_deswin;
									mymsg.id = m_eOtaMsg_loadFw;
									GUI_SendMessage(&mymsg);
									g_disable_close_scn();
								}
							}
							else
							{
								OnPaint(msg, m_eOnPaintIdx_exBn_chkNew, 0);
								ota_attr->xml = bbc_get_firmwareInfo();
								__msg("ota_attr->xml=0x%X\n", ota_attr->xml);
								
								if(ota_attr->xml == NULL)
								{
									__wrn("You need check upgrade.ini or wifi status\n");
									gscene_hbar_set_state(HBAR_ST_HIDE);
									app_tips_show(NULL, STRING_OTA_XML_STA_OTHER_CUE);
									gscene_hbar_set_state(HBAR_ST_SHOW);
									OnPaint(msg, m_eOnPaintIdx_exBn_chkNew, 1);
								}
								else
								{
									OnPaint(msg, m_eOnPaintIdx_exInfoNew, 0);
									OnPaint(msg, m_eOnPaintIdx_exBn_update, 1);								
									if(!ota_load_tid)
									{
										ota_load_tid = esKRNL_TCreate(ota_load_thread, msg, 0x10000,KRNL_priolevel4);
																		
									}
								}
							}
							break;
						}
							
						case m_eOnBnIdx_exit:
						{
							ota_cmd2parent(msg->h_deswin, SWITCH_TO_MMENU, 0, 0);
							break;
						}
								
						default:
							break;
					}
					
					break;
				}

				case GUI_MSG_KEY_MENU:
				{
					ota_cmd2parent(msg->h_deswin, SWITCH_TO_MMENU, 0, 0);
					break;
				}

				default:
				{
					break;
				}

			}

			__here__;
			return EPDK_OK;
		}

		case GUI_MSG_COMMAND:
		{

		}

		return EPDK_OK;

		case GUI_MSG_TIMER:
		{


			return EPDK_OK;
		}

		case GUI_MSG_TOUCH:
		{
			ota_attr_t *ota_attr;
			ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);
			ota_touch_proc(msg, ota_attr);
			return EPDK_OK;
		}

		case m_eOtaMsg_loadFw:
		{
			ota_attr_t *ota_attr;
			ota_attr = (ota_attr_t *)GUI_WinGetAttr(msg->h_deswin);
			ota_attr->state = m_eOtaSta_load;
			//eLIBs_printf("start to load img\n");
			POST_OTA_CTL_SEM;
			__here__;
			return EPDK_OK;
		}

		default:
			break;
	}

	//return EPDK_OK;
	return GUI_FrmWinDefaultProc(msg);
}


H_WIN ota_frame_win_create(H_WIN h_parent, ota_ctrl_t *ota_ctrl)
{
	__gui_framewincreate_para_t framewin_para;
	ota_attr_t *ota_attr;
	H_WIN win = NULL;
	FB fb;
	RECT rect;


	__wrn("enter sel win\n");
	ota_attr = (ota_attr_t *)esMEMS_Balloc(sizeof(ota_attr_t));

	if(!ota_attr)
	{

		__msg("memory balloc fail.........\n");
		return EPDK_FAIL;
	}

	eLIBs_memset((void *)ota_attr, 0, sizeof(ota_attr_t));

	ota_attr->font = SWFFont;
	rect.x = 0;
	rect.y = 0;
	rect.width = _W_SCR_;
	rect.height = _H_SCR_;
	ota_attr->layer = ota_layer_32bpp_create(rect, 1);

	eLIBs_memset(&framewin_para, 0, sizeof(__gui_framewincreate_para_t));
	framewin_para.name =	"ota frame win";
	framewin_para.dwExStyle = WS_EX_NONE;
	framewin_para.dwStyle = WS_NONE | WS_VISIBLE;
	framewin_para.spCaption =  NULL;
	framewin_para.hOwner	= NULL;
	framewin_para.id         = OTA_FRM_ID;
	framewin_para.hHosting = h_parent;
	framewin_para.FrameWinProc = (__pGUI_WIN_CB)esKRNL_GetCallBack((__pCBK_t)Ota_Frmwin_Proc);
	framewin_para.rect = rect;
	framewin_para.BkColor.alpha =  0;
	framewin_para.BkColor.red = 0;
	framewin_para.BkColor.green = 0;
	framewin_para.BkColor.blue = 0;
	framewin_para.attr = (void *)ota_attr;
	framewin_para.hLayer = ota_attr->layer;
	win = GUI_FrmWinCreate(&framewin_para);

	if(win == NULL)
	{
		__wrn("cook_frw create fail cook_attr free\n");
		GUI_LyrWinDelete(ota_attr->layer);
		esMEMS_Bfree(ota_attr, sizeof(ota_attr_t));
		ota_attr = NULL;
		return EPDK_FAIL;
	}

	GUI_WinSetFocusChild(win);
	return win;//..(GUI_FrmWinCreate(&framewin_para));
}

void ota_frame_win_delete(H_WIN ota_frmwin)
{
	ota_attr_t *ota_attr;
	ota_attr = (ota_attr_t *)GUI_WinGetAttr(ota_frmwin);

	if(ota_attr->layer)
	{
		__log("GUI_MSG_DESTROY2\n");
		GUI_LyrWinDelete(ota_attr->layer);
		//ota_attr->layer = NULL;
	}
}

static __s32 __app_ota_proc(__gui_msg_t *msg)
{
	__msg("__app_ota_proc: msg->id=%d, msg->h_deswin=%x, msg->dwAddData1=%d, msg->dwAddData2=%d\n"
		  , msg->id, msg->h_deswin, msg->dwAddData1, msg->dwAddData2);

	switch(msg->id)
	{
		case GUI_MSG_CREATE:
		{

			ota_ctrl_t *ota_ctrl;
			ota_ctrl	 = (ota_ctrl_t *)GUI_WinGetAttr(msg->h_deswin);
			ota_ctrl->ota_frmwin = ota_frame_win_create(msg->h_deswin, ota_ctrl);
			GUI_WinSetFocusChild(ota_ctrl->ota_frmwin);
			gscene_hbar_set_state(HBAR_ST_SHOW);
			gscene_hbar_set_text(HB_APP_OTA);
			return EPDK_OK;

		}

		case GUI_MSG_KEY:
		{
			break;

		}

		case GUI_MSG_CLOSE:
		{


			return EPDK_OK;
		}

		case GUI_MSG_TOUCH:
		{
			break;
		}

		case GUI_MSG_TIMER:
		{

			return EPDK_OK;

		}

		case GUI_MSG_DESTROY:
		{
			ota_ctrl_t *ota_ctrl;
			ota_ctrl	 = (ota_ctrl_t *)GUI_WinGetAttr(msg->h_deswin);

			if(ota_ctrl->h_dialoag_win)
			{
				app_dialog_destroy(ota_ctrl->h_dialoag_win);
				ota_ctrl->h_dialoag_win = NULL ;
			}

			if(ota_ctrl->ota_frmwin)
			{
				ota_frame_win_delete(ota_ctrl->ota_frmwin);
				ota_ctrl->ota_frmwin = NULL;
			}

			if(ota_ctrl)
			{
				__log("GUI_MSG_DESTROY9\n");
				esMEMS_Bfree(ota_ctrl, sizeof(ota_ctrl_t));
				ota_ctrl = NULL;
			}

			//			gscene_hbar_set_state(HBAR_ST_HIDE);
			//			gscene_bgd_set_state(BGD_STATUS_SHOW);
			return EPDK_OK;
		}

		case GUI_MSG_COMMAND:
		{
			ota_ctrl_t *ota_ctrl = (ota_ctrl_t *)GUI_WinGetAttr(msg->h_deswin);

			switch(LOWORD(msg->dwAddData1))
			{
				case OTA_FRM_ID:
				{
					__here__;

					switch(HIWORD(msg->dwAddData1))
					{
						case SWITCH_TO_MMENU:
						{
							ota_cmd2parent(msg->h_deswin, ID_SWITCH_TO_GENERAL, 0, 0);//退出ota
							break;
						}

						case SWITCH_TO_MODAL_DIALOG:
						{

							__s32 lang_id[] = {STRING_SET_CUE , STRING_OTA_FW_UP_CUE};
							default_dialog(ota_ctrl->h_dialoag_win , msg->h_deswin , APP_OTA_DLG_ID, ADLG_YESNO, lang_id);
							__msg("ota_ctrl->h_dialoag_win=0x%X\n", ota_ctrl->h_dialoag_win);
							break;
						}

						default:
							break;
					}

					break;
				}

				case APP_OTA_DLG_ID:
				{
					__here__;

					switch(HIWORD(msg->dwAddData1))
					{
						case ADLG_CMD_EXIT:
						{
							__here__ ;
							app_dialog_destroy(ota_ctrl->h_dialoag_win) ;
							ota_ctrl->h_dialoag_win = NULL ;

							if(ADLG_IDNO == msg->dwAddData2)
							{
								ota_cmd2parent(msg->h_deswin, ID_SWITCH_TO_GENERAL, 0, 0);//退出ota
							}
							else if(ADLG_IDYES == msg->dwAddData2)
							{
								//加载、升级固件
								__gui_msg_t mymsg;
								__here__ ;
								mymsg.h_deswin = ota_ctrl->ota_frmwin;
								mymsg.id = m_eOtaMsg_loadFw;
								GUI_SendMessage(&mymsg);
							}

							break;
						}

						default:
							break;
					}

					break;
				}
			}

			return EPDK_OK;
		}

		case DSK_MSG_TVDAC_PLUGOUT:
		case DSK_MSG_HDMI_PLUGOUT:
		{

			return EPDK_OK;
		}

		case DSK_MSG_FS_PART_PLUGOUT:
		{


			return EPDK_OK;
		}

		case DSK_MSG_HOME:
		{


			return EPDK_OK;
		}

		default:
		{
			__msg("__app_ota_proc: default\n");

			break;
		}
	}

	return GUI_ManWinDefaultProc(msg);
}

H_WIN app_ota_create(H_WIN h_parent)
{
	__gui_manwincreate_para_t create_info;
	H_WIN hManWin;
	ota_ctrl_t *ota_ctrl;
	//__msg("esKSRV_SysInfo: %d", esKSRV_SysInfo());
	__inf("****************************************************************************************\n");
	__inf("********  enter ota app  **************\n");
	__inf("****************************************************************************************\n");
	//	gscene_bgd_set_state(BGD_STATUS_HIDE);
	// esKSRV_SysInfo();
	ota_ctrl = (ota_ctrl_t *)esMEMS_Balloc(sizeof(ota_ctrl_t));

	if(!ota_ctrl)
	{

		__msg("memory balloc fail.........\n");
		return EPDK_FAIL;
	}

	eLIBs_memset(ota_ctrl, 0, sizeof(ota_ctrl_t));

	eLIBs_memset(&create_info, 0, sizeof(__gui_manwincreate_para_t));

	create_info.name            = APP_OTA;
	create_info.hParent         = h_parent;
	create_info.ManWindowProc   = (__pGUI_WIN_CB)esKRNL_GetCallBack((__pCBK_t)__app_ota_proc);
	create_info.attr            = (void *)ota_ctrl;
	create_info.id				= APP_OTA_ID;
	create_info.hHosting        = NULL;

	hManWin = GUI_ManWinCreate(&create_info);

	__msg("app_ota_create, hManWin=%x\n", hManWin);
	return hManWin;
}

